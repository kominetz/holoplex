#!/bin/bash
set -e

usage() {
  echo "Usage:"
  echo "  holodeck build <group>.md"
  echo "  holodeck check <group>.md"
  echo "  holodeck extract <group>.md"
  echo "  holodeck clean <group>.md"
  echo
  echo "  Example: holodeck build the_bridge.md"
  exit 1
}

if [ "$#" -lt 2 ]; then
  usage
fi

CMD=$1
CFG=$2

# Derive group name (e.g., "the_bridge" from the_bridge.md)
GROUP=$(basename "$CFG" .md)

EXTRACTOR="bin/${GROUP}_extractor.py"
BATCHER="bin/${GROUP}_batcher.py"
PERSONA_CHECKER="bin/persona_checker.py"
MANIFEST_FILE="build/${GROUP}_manifest.yaml"
BUILD_DIR="build/$GROUP"

case "$CMD" in
  build)
    # Always clean before a new build
    if [ -f "$MANIFEST_FILE" ]; then
      rm "$MANIFEST_FILE"
      echo "Removed $MANIFEST_FILE"
    fi
    if [ -d "$BUILD_DIR" ]; then
      rm -rf "$BUILD_DIR"
      echo "Removed previous $BUILD_DIR/"
    fi
    
    # Step 1: Extract manifest to build/<group>/
    python bin/${GROUP}_extractor.py
    # Step 2: Check persona files against manifest
    python bin/persona_checker.py "$GROUP"
    # Step 3: Batch persona files
    python bin/${GROUP}_batcher.py
    echo "Holodeck build complete for $CFG â†’ $BUILD_DIR/"
    ;;
  check)
    python bin/${GROUP}_extractor.py
    python bin/persona_checker.py "$GROUP"
    ;;
  extract)
    python bin/${GROUP}_extractor.py
    ;;
  clean)
    clean_anything=0
    if [ -f "$MANIFEST_FILE" ]; then
      rm "$MANIFEST_FILE"
      echo "Removed $MANIFEST_FILE"
      clean_anything=1
    fi
    if [ -d "$BUILD_DIR" ]; then
      rm -rf "$BUILD_DIR"
      echo "Removed $BUILD_DIR/"
      clean_anything=1
    fi
    if [ $clean_anything -eq 0 ]; then
      echo "Nothing to clean for $GROUP."
    fi
    ;;
  *)
    usage
    ;;
esac
