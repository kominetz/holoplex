#!/bin/bash

set -e

usage() {
    echo "Usage:"
    echo "  holoplex build <holodeck>"
    echo "  holoplex clean <holodeck>"
    echo
    echo "Example: holoplex build the_bridge"
    exit 1
}

if [ "$#" -lt 2 ]; then
    usage
fi

CMD=$1
HOLODECK=$2

# Paths and filenames
HOLODECK_DIR="holodecks/$HOLODECK"
BUILD_DIR="build/$HOLODECK"
COMPILER="bin/holodeck_compiler.py"

# Check holodeck directory
if [ ! -d "$HOLODECK_DIR" ]; then
    echo "Error: Holodeck directory '$HOLODECK_DIR' does not exist."
    exit 1
fi

case "$CMD" in
    build)
        # Clean old build outputs
        if [ -d "$BUILD_DIR" ]; then
            rm -rf "$BUILD_DIR"
            echo "Removed previous $BUILD_DIR/"
        fi
        # Batch persona files using the new compiler
        python "$COMPILER" "$HOLODECK"
        echo "Holoplex build complete for $HOLODECK â†’ $BUILD_DIR/"
        ;;
    clean)
        if [ -d "$BUILD_DIR" ]; then
            rm -rf "$BUILD_DIR"
            echo "Removed $BUILD_DIR/"
            CLEANED=1
        else
            echo "No build directory to clean: $BUILD_DIR"
        fi
        ;;
    *)
        usage
        ;;
esac
